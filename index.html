<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Ïó¨Ìñâ Í¥ÄÎ¶¨">
    <title>Ïó¨Ìñâ Í¥ÄÎ¶¨ ÎåÄÏãúÎ≥¥Îìú</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s, color 0.3s;
        }
        body { 
            margin: 0;
            padding: 0;
            overscroll-behavior: none;
        }
        body.dark {
            background: #1a1a1a;
        }
        .dark .bg-white { background: #2a2a2a !important; color: #e0e0e0; }
        .dark .text-gray-900 { color: #e0e0e0 !important; }
        .dark .text-gray-800 { color: #d0d0d0 !important; }
        .dark .text-gray-500 { color: #a0a0a0 !important; }
        .dark .border-gray-100 { border-color: #3a3a3a !important; }
        .dark input, .dark textarea, .dark select {
            background: #333 !important;
            color: #e0e0e0 !important;
            border-color: #4a4a4a !important;
        }
        button { cursor: pointer; user-select: none; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50">
    <div id="root"></div>

    <script>
        const app = {
            state: {
                activeTab: 'home',
                editingTitle: false,
                tempTitle: '',
                language: 'ko',
                darkMode: false,
                data: {
                    title: 'ÎÇ¥ Ïó¨Ìñâ',
                    startDate: '',
                    endDate: '',
                    photos: [],
                    schedule: [],
                    expenses: [],
                    currency: 'KRW'
                }
            },

            translations: {
                ko: {
                    myTrip: 'ÎÇ¥ Ïó¨Ìñâ', period: 'Í∏∞Í∞Ñ', notSet: 'ÎØ∏Ï†ï', photos: 'ÏÇ¨ÏßÑ',
                    schedule: 'ÏùºÏ†ï', expenses: 'ÏßÄÏ∂ú', export: 'ÎÇ¥Î≥¥ÎÇ¥Í∏∞', import: 'Î∂àÎü¨Ïò§Í∏∞',
                    home: 'Ìôà', photoAlbum: 'ÏÇ¨ÏßÑÏ≤©', travelOverview: 'Ïó¨Ìñâ Í∞úÏöî',
                    memories: 'Ï∂îÏñµ ÏÇ¨ÏßÑ', addPhoto: 'ÏÇ¨ÏßÑ Ï∂îÍ∞Ä', addDescription: 'ÏÑ§Î™Ö Ï∂îÍ∞Ä...',
                    addSchedule: 'ÏùºÏ†ï Ï∂îÍ∞Ä', title: 'Ï†úÎ™©', details: 'ÏÉÅÏÑ∏ ÎÇ¥Ïö©',
                    totalExpense: 'Ï¥ù ÏßÄÏ∂ú', addExpense: 'ÏßÄÏ∂ú Ï∂îÍ∞Ä', expenseItem: 'ÏßÄÏ∂ú Ìï≠Î™©',
                    amount: 'Í∏àÏï°', dataImported: 'Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨ÏôîÏäµÎãàÎã§!',
                    importFailed: 'ÌååÏùºÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.',
                    photos_count: 'Ïû•', schedule_count: 'Í∞ú', resetAll: 'Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî',
                    resetConfirm: 'Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏÇ¨ÏßÑ, ÏùºÏ†ï, ÏßÄÏ∂ú ÎÇ¥Ïó≠Ïù¥ Î™®Îëê ÏÇ≠Ï†úÎê©ÎãàÎã§.',
                    resetSuccess: 'Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.',
                    category: 'Ïπ¥ÌÖåÍ≥†Î¶¨', statistics: 'ÌÜµÍ≥Ñ', share: 'Í≥µÏú†',
                    darkMode: 'Îã§ÌÅ¨Î™®Îìú', categoryFood: 'ÏùåÏãù', categoryAccom: 'ÏàôÎ∞ï',
                    categoryTrans: 'ÍµêÌÜµ', categoryTour: 'Í¥ÄÍ¥ë', categoryShopping: 'ÏáºÌïë',
                    categoryOther: 'Í∏∞ÌÉÄ', notifications: 'ÏïåÎ¶º', enableNotif: 'ÏïåÎ¶º ÏºúÍ∏∞',
                    shareText: 'ÎÇ¥ Ïó¨Ìñâ Ï†ïÎ≥¥Î•º Í≥µÏú†Ìï©ÎãàÎã§!'
                },
                th: {
                    myTrip: '‡∏ó‡∏£‡∏¥‡∏õ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô', period: '‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤', notSet: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î', photos: '‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û',
                    schedule: '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£', expenses: '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢', export: '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å', import: '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤',
                    home: '‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å', photoAlbum: '‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°‡∏£‡∏π‡∏õ', travelOverview: '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á',
                    memories: '‡∏†‡∏≤‡∏û‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥', addPhoto: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', addDescription: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢...',
                    addSchedule: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£', title: '‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠', details: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î',
                    totalExpense: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°', addExpense: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢', expenseItem: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢',
                    amount: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô', dataImported: '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    importFailed: '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                    photos_count: '‡∏†‡∏≤‡∏û', schedule_count: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', resetAll: '‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                    resetConfirm: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö',
                    resetSuccess: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    category: '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', statistics: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥', share: '‡πÅ‡∏ä‡∏£‡πå',
                    darkMode: '‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î', categoryFood: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£', categoryAccom: '‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å',
                    categoryTrans: '‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á', categoryTour: '‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß', categoryShopping: '‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á',
                    categoryOther: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ', notifications: '‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', enableNotif: '‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',
                    shareText: '‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô!'
                }
            },

            categories: [
                { id: 'food', icon: 'üçî', color: '#ef4444' },
                { id: 'accommodation', icon: 'üè®', color: '#f59e0b' },
                { id: 'transport', icon: 'üöó', color: '#3b82f6' },
                { id: 'tourism', icon: 'üé≠', color: '#8b5cf6' },
                { id: 'shopping', icon: 'üõçÔ∏è', color: '#ec4899' },
                { id: 'other', icon: 'üí∞', color: '#6b7280' }
            ],

            currencies: [
                { code: 'KRW', name: 'Ïõê (Won)' },
                { code: 'THB', name: '‡∏ö‡∏≤‡∏ó (Baht)' },
                { code: 'VND', name: 'Îèô (Dong)' },
                { code: 'USD', name: 'Dollar' },
                { code: 'EUR', name: 'Euro' },
                { code: 'JPY', name: 'ÂÜÜ (Yen)' },
                { code: 'CNY', name: 'ÂÖÉ (Yuan)' }
            ],

            t(key) {
                return this.translations[this.state.language][key] || key;
            },

            init() {
                this.loadData();
                this.requestNotificationPermission();
                this.render();
            },

            loadData() {
                try {
                    const saved = localStorage.getItem('travelData');
                    if (saved) this.state.data = JSON.parse(saved);
                    
                    const savedLang = localStorage.getItem('travelLanguage');
                    if (savedLang) this.state.language = savedLang;

                    const savedDark = localStorage.getItem('darkMode');
                    if (savedDark === 'true') {
                        this.state.darkMode = true;
                        document.body.classList.add('dark');
                    }
                } catch (e) {
                    console.error('Load error:', e);
                }
            },

            saveData() {
                try {
                    this.sortScheduleAndExpenses();
                    localStorage.setItem('travelData', JSON.stringify(this.state.data));
                    localStorage.setItem('travelLanguage', this.state.language);
                    localStorage.setItem('darkMode', this.state.darkMode);
                } catch (e) {
                    console.error('Save error:', e);
                }
            },

            sortScheduleAndExpenses() {
                this.state.data.schedule.sort((a, b) => 
                    new Date(`${a.date || '9999-12-31'} ${a.time || '23:59'}`) - 
                    new Date(`${b.date || '9999-12-31'} ${b.time || '23:59'}`)
                );
                this.state.data.expenses.sort((a, b) => 
                    new Date(`${a.date || '9999-12-31'} ${a.time || '23:59'}`) - 
                    new Date(`${b.date || '9999-12-31'} ${b.time || '23:59'}`)
                );
            },

            compressImage(file, callback) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 1200;
                        const MAX_HEIGHT = 1200;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        callback(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            },

            render() {
                const root = document.getElementById('root');
                root.innerHTML = `
                    <div class="max-w-md mx-auto bg-white shadow-lg min-h-screen flex flex-col ${this.state.darkMode ? 'dark' : ''}">
                        ${this.renderHeader()}
                        ${this.renderTabs()}
                        <div class="flex-1 overflow-y-auto p-4">
                            ${this.renderContent()}
                        </div>
                    </div>
                `;
            },

            renderHeader() {
                return `
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex-1">
                                ${this.state.editingTitle ? `
                                    <div class="flex items-center gap-2">
                                        <input id="titleInput" type="text" value="${this.state.tempTitle}" class="flex-1 px-2 py-1 rounded text-gray-900">
                                        <button onclick="app.saveTitle()" class="p-1 bg-white rounded text-blue-600">üíæ</button>
                                    </div>
                                ` : `
                                    <div class="flex items-center gap-2">
                                        <h1 class="text-2xl font-bold">${this.state.data.title}</h1>
                                        <button onclick="app.editTitle()" class="p-1">‚úèÔ∏è</button>
                                    </div>
                                `}
                            </div>
                            <div class="flex gap-2">
                                <button onclick="app.toggleDarkMode()" class="px-2 py-1 bg-white bg-opacity-20 rounded-lg text-sm">
                                    ${this.state.darkMode ? '‚òÄÔ∏è' : 'üåô'}
                                </button>
                                <button onclick="app.toggleLanguage()" class="px-2 py-1 bg-white bg-opacity-20 rounded-lg text-sm">
                                    üåê ${this.state.language === 'ko' ? 'TH' : 'KO'}
                                </button>
                            </div>
                        </div>
                        <div class="flex gap-2 text-sm">
                            <input id="startDate" type="date" value="${this.state.data.startDate}" onchange="app.updateDate('startDate', this.value)" class="flex-1 px-2 py-1 rounded text-gray-900">
                            <span class="self-center">~</span>
                            <input id="endDate" type="date" value="${this.state.data.endDate}" onchange="app.updateDate('endDate', this.value)" class="flex-1 px-2 py-1 rounded text-gray-900">
                        </div>
                        <div class="grid grid-cols-2 gap-2 mt-3">
                            <button onclick="app.exportData()" class="bg-white text-blue-600 px-3 py-2 rounded-lg text-sm font-medium">
                                ‚¨áÔ∏è ${this.t('export')}
                            </button>
                            <label class="bg-white text-blue-600 px-3 py-2 rounded-lg text-sm font-medium text-center cursor-pointer">
                                ‚¨ÜÔ∏è ${this.t('import')}
                                <input type="file" accept=".json" onchange="app.importData(event)" class="hidden">
                            </label>
                            <button onclick="app.shareTrip()" class="bg-white text-blue-600 px-3 py-2 rounded-lg text-sm font-medium col-span-2">
                                üì§ ${this.t('share')}
                            </button>
                        </div>
                    </div>
                `;
            },

            renderTabs() {
                const tabs = [
                    { id: 'home', icon: 'üè†', label: this.t('home') },
                    { id: 'photos', icon: 'üì∑', label: this.t('photoAlbum') },
                    { id: 'schedule', icon: 'üìÖ', label: this.t('schedule') },
                    { id: 'expenses', icon: 'üí∞', label: this.t('expenses') },
                    { id: 'stats', icon: 'üìä', label: this.t('statistics') }
                ];

                return `
                    <div class="flex border-b bg-white overflow-x-auto">
                        ${tabs.map(tab => `
                            <button 
                                onclick="app.switchTab('${tab.id}')"
                                class="flex-1 min-w-fit py-3 px-2 flex flex-col items-center gap-1 ${
                                    this.state.activeTab === tab.id ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'
                                }">
                                <span class="text-xl">${tab.icon}</span>
                                <span class="text-xs font-medium whitespace-nowrap">${tab.label}</span>
                            </button>
                        `).join('')}
                    </div>
                `;
            },

            renderContent() {
                switch(this.state.activeTab) {
                    case 'home': return this.renderHome();
                    case 'photos': return this.renderPhotos();
                    case 'schedule': return this.renderSchedule();
                    case 'expenses': return this.renderExpenses();
                    case 'stats': return this.renderStats();
                    default: return '';
                }
            },

            renderHome() {
                const total = this.state.data.expenses.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
                return `
                    <div class="space-y-4">
                        <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl p-6 text-white shadow-lg">
                            <h2 class="text-xl font-bold mb-2">${this.t('travelOverview')}</h2>
                            <div class="space-y-2 text-sm">
                                <p>${this.t('period')}: ${this.state.data.startDate || this.t('notSet')} ~ ${this.state.data.endDate || this.t('notSet')}</p>
                                <p>${this.t('photos')}: ${this.state.data.photos.length}${this.t('photos_count')}</p>
                                <p>${this.t('schedule')}: ${this.state.data.schedule.length}${this.t('schedule_count')}</p>
                                <p>${this.t('expenses')}: ${total.toLocaleString()} ${this.state.data.currency}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-white rounded-lg p-4 shadow border border-gray-100">
                                <p class="text-4xl mb-2">üì∑</p>
                                <p class="text-2xl font-bold text-gray-800">${this.state.data.photos.length}</p>
                                <p class="text-xs text-gray-500">${this.t('memories')}</p>
                            </div>
                            <div class="bg-white rounded-lg p-4 shadow border border-gray-100">
                                <p class="text-4xl mb-2">üìÖ</p>
                                <p class="text-2xl font-bold text-gray-800">${this.state.data.schedule.length}</p>
                                <p class="text-xs text-gray-500">${this.t('schedule')}</p>
                            </div>
                        </div>
                        <button onclick="app.resetAll()" class="w-full bg-red-500 text-white py-3 rounded-lg font-medium hover:bg-red-600">
                            üóëÔ∏è ${this.t('resetAll')}
                        </button>
                    </div>
                `;
            },

            renderPhotos() {
                return `
                    <div class="space-y-4">
                        <label class="block w-full bg-blue-600 text-white py-3 rounded-lg text-center font-medium cursor-pointer">
                            ‚ûï ${this.t('addPhoto')}
                            <input type="file" multiple accept="image/*" onchange="app.addPhotos(event)" class="hidden">
                        </label>
                        <div class="grid grid-cols-2 gap-3">
                            ${this.state.data.photos.map((photo, idx) => `
                                <div class="relative bg-white rounded-lg overflow-hidden shadow border border-gray-100">
                                    <img src="${photo.url}" class="w-full h-40 object-cover">
                                    <button onclick="app.deletePhoto(${idx})" class="absolute top-2 right-2 bg-red-500 text-white w-6 h-6 rounded-full">‚úï</button>
                                    <div class="p-2">
                                        <textarea onblur="app.updatePhotoDesc(${idx}, this.value)" class="w-full text-sm border rounded p-1 resize-none" rows="2" placeholder="${this.t('addDescription')}">${photo.description}</textarea>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            renderSchedule() {
                return `
                    <div class="space-y-3">
                        <button onclick="app.addSchedule()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium">
                            ‚ûï ${this.t('addSchedule')}
                        </button>
                        ${this.state.data.schedule.map((item, idx) => `
                            <div class="bg-white rounded-lg p-4 shadow border border-gray-100">
                                <div class="flex justify-between mb-3">
                                    <div class="flex-1 grid grid-cols-2 gap-2">
                                        <input type="date" value="${item.date}" onblur="app.updateSchedule(${idx}, 'date', this.value)" class="border rounded px-2 py-1 text-sm">
                                        <input type="time" value="${item.time}" onblur="app.updateSchedule(${idx}, 'time', this.value)" class="border rounded px-2 py-1 text-sm">
                                    </div>
                                    <button onclick="app.deleteSchedule(${idx})" class="text-red-500 ml-2">‚úï</button>
                                </div>
                                <input type="text" value="${item.title}" onblur="app.updateSchedule(${idx}, 'title', this.value)" placeholder="${this.t('title')}" class="w-full border rounded px-3 py-2 mb-2">
                                <textarea onblur="app.updateSchedule(${idx}, 'description', this.value)" placeholder="${this.t('details')}" class="w-full border rounded px-3 py-2 text-sm resize-none" rows="2">${item.description || ''}</textarea>
                                ${item.date && item.time ? `
                                    <button onclick="app.scheduleNotification('${item.title}', '${item.date}', '${item.time}')" class="mt-2 text-xs text-blue-600">
                                        üîî ${this.t('notifications')}
                                    </button>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            renderExpenses() {
                const total = this.state.data.expenses.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);

                return `
                    <div class="space-y-3">
                        <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-lg p-4 text-white shadow-lg">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-sm">${this.t('totalExpense')}</p>
                                <select onchange="app.updateCurrency(this.value)" class="bg-white text-gray-900 px-2 py-1 rounded text-sm">
                                    ${this.currencies.map(c => `
                                        <option value="${c.code}" ${c.code === this.state.data.currency ? 'selected' : ''}>${c.code}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <p class="text-3xl font-bold total-amount">${total.toLocaleString()}</p>
                            <p class="text-sm opacity-90">${this.currencies.find(c => c.code === this.state.data.currency)?.name}</p>
                        </div>
                        <button onclick="app.addExpense()" class="w-full bg-green-600 text-white py-3 rounded-lg font-medium">
                            ‚ûï ${this.t('addExpense')}
                        </button>
                        ${this.state.data.expenses.map((item, idx) => {
                            const cat = this.categories.find(c => c.id === item.category) || this.categories[5];
                            return `
                            <div class="bg-white rounded-lg p-4 shadow border border-gray-100">
                                <div class="flex justify-between mb-3">
                                    <div class="flex-1 grid grid-cols-2 gap-2">
                                        <input type="date" value="${item.date}" onblur="app.updateExpense(${idx}, 'date', this.value)" class="border rounded px-2 py-1 text-sm">
                                        <input type="time" value="${item.time}" onblur="app.updateExpense(${idx}, 'time', this.value)" class="border rounded px-2 py-1 text-sm">
                                    </div>
                                    <button onclick="app.deleteExpense(${idx})" class="text-red-500 ml-2">‚úï</button>
                                </div>
                                <select onchange="app.updateExpense(${idx}, 'category', this.value)" class="w-full border rounded px-3 py-2 mb-2 text-sm">
                                    ${this.categories.map(c => `
                                        <option value="${c.id}" ${c.id === item.category ? 'selected' : ''}>
                                            ${c.icon} ${this.t('category' + c.id.charAt(0).toUpperCase() + c.id.slice(1))}
                                        </option>
                                    `).join('')}
                                </select>
                                <input type="text" value="${item.title}" onblur="app.updateExpense(${idx}, 'title', this.value)" placeholder="${this.t('expenseItem')}" class="w-full border rounded px-3 py-2 mb-2">
                                <div class="flex gap-2">
                                    <input type="number" value="${item.amount}" 
                                        onfocus="if(this.value == 0 || this.value == '0') this.select()" 
                                        oninput="app.updateExpense(${idx}, 'amount', this.value)" 
                                        placeholder="${this.t('amount')}" 
                                        class="flex-1 border rounded px-3 py-2">
                                    <span class="self-center text-sm font-medium px-2 py-2 rounded" style="background: ${cat.color}20; color: ${cat.color}">
                                        ${cat.icon}
                                    </span>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                `;
            },

            renderStats() {
                const categoryTotals = {};
                this.categories.forEach(cat => categoryTotals[cat.id] = 0);
                
                this.state.data.expenses.forEach(exp => {
                    const cat = exp.category || 'other';
                    categoryTotals[cat] += parseFloat(exp.amount) || 0;
                });

                const grandTotal = Object.values(categoryTotals).reduce((a,b) => a+b, 0);

                return `
                    <div class="space-y-4">
                        <div class="bg-gradient-to-r from-purple-500 to-pink-600 rounded-xl p-6 text-white shadow-lg">
                            <h2 class="text-xl font-bold mb-2">${this.t('category')} ${this.t('statistics')}</h2>
                            <p class="text-3xl font-bold">${grandTotal.toLocaleString()}</p>
                            <p class="text-sm opacity-90">${this.t('totalExpense')} (${this.state.data.currency})</p>
                        </div>

                        <div class="space-y-3">
                            ${this.categories.map(cat => {
                                const total = categoryTotals[cat.id];
                                const percent = grandTotal > 0 ? (total / grandTotal * 100).toFixed(1) : 0;
                                return `
                                    <div class="bg-white rounded-lg p-4 shadow border border-gray-100">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex items-center gap-3">
                                                <span class="text-3xl">${cat.icon}</span>
                                                <div>
                                                    <p class="font-medium text-gray-800">${this.t('category' + cat.id.charAt(0).toUpperCase() + cat.id.slice(1))}</p>
                                                    <p class="text-xs text-gray-500">${this.state.data.expenses.filter(e => e.category === cat.id).length} ${this.t('schedule_count')}</p>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-xl font-bold text-gray-800">${total.toLocaleString()}</p>
                                                <p class="text-sm" style="color: ${cat.color}">${percent}%</p>
                                            </div>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="h-2 rounded-full" style="width: ${percent}%; background-color: ${cat.color}"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            },

            switchTab(tab) {
                this.state.activeTab = tab;
                this.render();
            },

            toggleLanguage() {
                this.state.language = this.state.language === 'ko' ? 'th' : 'ko';
                this.saveData();
                this.render();
            },

            toggleDarkMode() {
                this.state.darkMode = !this.state.darkMode;
                if (this.state.darkMode) {
                    document.body.classList.add('dark');
                } else {
                    document.body.classList.remove('dark');
                }
                this.saveData();
                this.render(); // Re-render to update the root element class
            },

            editTitle() {
                this.state.tempTitle = this.state.data.title;
                this.state.editingTitle = true;
                this.render();
            },

            saveTitle() {
                this.state.data.title = document.getElementById('titleInput').value;
                this.state.editingTitle = false;
                this.saveData();
                this.render();
            },

            updateDate(field, value) {
                this.state.data[field] = value;
                this.saveData();
            },

            addPhotos(event) {
                const files = Array.from(event.target.files);
                let loaded = 0;
                files.forEach(file => {
                    this.compressImage(file, (compressedUrl) => {
                        this.state.data.photos.push({
                            id: Date.now() + Math.random(),
                            url: compressedUrl,
                            description: '',
                            date: new Date().toISOString()
                        });
                        loaded++;
                        if (loaded === files.length) {
                            this.saveData();
                            this.render();
                        }
                    });
                });
            },

            deletePhoto(idx) {
                this.state.data.photos.splice(idx, 1);
                this.saveData();
                this.render();
            },

            updatePhotoDesc(idx, value) {
                this.state.data.photos[idx].description = value;
                this.saveData();
            },

            addSchedule() {
                this.state.data.schedule.push({
                    id: Date.now(),
                    date: '',
                    time: '',
                    title: '',
                    description: ''
                });
                this.saveData();
                this.render();
            },

            updateSchedule(idx, field, value) {
                this.state.data.schedule[idx][field] = value;
                this.saveData();
                if (field === 'date' || field === 'time') {
                    setTimeout(() => this.render(), 100);
                }
            },

            deleteSchedule(idx) {
                this.state.data.schedule.splice(idx, 1);
                this.saveData();
                this.render();
            },

            addExpense() {
                this.state.data.expenses.push({
                    id: Date.now(),
                    date: '',
                    time: '',
                    title: '',
                    amount: 0,
                    category: 'other'
                });
                this.saveData();
                this.render();
            },

            updateExpense(idx, field, value) {
                this.state.data.expenses[idx][field] = field === 'amount' ? parseFloat(value) || 0 : value;
                this.saveData();
                if (field === 'amount') {
                    this.updateTotalDisplay();
                } else if (field === 'date' || field === 'time' || field === 'category') {
                    setTimeout(() => this.render(), 100);
                }
            },

            updateTotalDisplay() {
                const total = this.state.data.expenses.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
                const totalElement = document.querySelector('.total-amount');
                if (totalElement) {
                    totalElement.textContent = total.toLocaleString();
                }
            },

            deleteExpense(idx) {
                this.state.data.expenses.splice(idx, 1);
                this.saveData();
                this.render();
            },

            updateCurrency(value) {
                this.state.data.currency = value;
                this.saveData();
                this.render();
            },

            exportData() {
                const dataStr = JSON.stringify(this.state.data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `travel_${this.state.data.title}_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            },

            importData(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            this.state.data = JSON.parse(e.target.result);
                            this.saveData();
                            this.render();
                            alert(this.t('dataImported'));
                        } catch (error) {
                            alert(this.t('importFailed'));
                        }
                    };
                    reader.readAsText(file);
                }
            },

            shareTrip() {
                const total = this.state.data.expenses.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
                const text = `${this.state.data.title}\n${this.t('period')}: ${this.state.data.startDate} ~ ${this.state.data.endDate}\n${this.t('photos')}: ${this.state.data.photos.length}\n${this.t('schedule')}: ${this.state.data.schedule.length}\n${this.t('totalExpense')}: ${total.toLocaleString()} ${this.state.data.currency}`;
                
                if (navigator.share) {
                    navigator.share({
                        title: this.state.data.title,
                        text: text
                    }).catch(err => console.log('Share error:', err));
                } else {
                    alert(this.t('shareText') + '\n\n' + text);
                }
            },

            requestNotificationPermission() {
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            },

            scheduleNotification(title, date, time) {
                if (!('Notification' in window)) {
                    alert('This browser does not support notifications');
                    return;
                }

                if (Notification.permission === 'granted') {
                    const scheduleTime = new Date(`${date} ${time}`).getTime() - 3600000; // 1ÏãúÍ∞Ñ Ï†Ñ
                    const now = Date.now();
                    const timeout = scheduleTime - now;

                    if (timeout > 0) {
                        setTimeout(() => {
                            new Notification('Travel Reminder', {
                                body: `${title} in 1 hour!`,
                                icon: 'üìÖ'
                            });
                        }, timeout);
                        alert('Notification scheduled!');
                    } else {
                        alert('Schedule time has passed');
                    }
                } else {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            this.scheduleNotification(title, date, time);
                        }
                    });
                }
            },

            resetAll() {
                if (confirm(this.t('resetConfirm'))) {
                    this.state.data = {
                        title: this.state.language === 'ko' ? 'ÎÇ¥ Ïó¨Ìñâ' : '‡∏ó‡∏£‡∏¥‡∏õ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô',
                        startDate: '',
                        endDate: '',
                        photos: [],
                        schedule: [],
                        expenses: [],
                        currency: 'KRW'
                    };
                    this.saveData();
                    this.render();
                    alert(this.t('resetSuccess'));
                }
            }
        };

        app.init();
    </script>
</body>
</html>
